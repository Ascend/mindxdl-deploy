---
# distribute resources
- hosts:
    - master
    - worker
    - harbor
    - nfs_server
  roles:
    - role: mindx.resource
      vars:
        resource_list:
          - pylibs
          - linux_aarch64
          - linux_x86_64
            ubuntu_18.04_aarch64
          - ubuntu_18.04_x86_64

# copy harbor install package to harbor host
- hosts: harbor
  roles:
    - role: mindx.resource
      vars:
        resource_list:
          - harbor-offline-installer-v2.3.3.tgz
          - harbor-offline-installer-aarch64-v2.3.3.tgz

# install softwares
- hosts:
    - master
    - worker
    - harbor
  roles:
    - role: mindx.basic
    - role: mindx.docker
    - role: mindx.k8s.install
    - role: mindx.nfs.client

# install harbor
- hosts:
    - harbor
  roles:
    - role: mindx.harbor.install
- hosts:
    - master
    - worker
    - localhost
  roles:
    - role: mindx.harbor.login

- hosts: localhost
  roles:
    - role: mindx.harbor.push

# master init k8s
- hosts: master
  roles:
    - role: mindx.k8s.master
    - role: mindx.k8s.label
      vars:
        label_key: masterselector
        label_value: dls-master-node
    - role: mindx.k8s.prom
    - role: mindx.k8s.autolabel
    - role: mindx.kubeedge

# worker join k8s
- hosts: worker
  roles:
    - role: mindx.k8s.worker
    - role: mindx.k8s.autolabel

# config nfs server
- hosts: nfs_server
  roles:
    - role: mindx.nfs.server
      vars:
        nfs_exports:
          - /data/platform
          - /data/user

# mysql
- hosts: mysql
  roles:
    - role: mindx.k8s.label
      vars:
        label_key: mysql
        label_value: master
    - role: mindx.mysql
      vars:
        capacity: 20Gi
        data_path: "{{ MYSQL_DATAPATH }}"
